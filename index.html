<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RestaurantIA - Analysez vos commentaires Google avec l'IA</title>
    <meta name="description" content="Analysez automatiquement tous vos avis Google avec notre IA avancée. Obtenez des insights précieux sur le sentiment client et améliorez votre restaurant." />
    <meta name="author" content="RestaurantIA" />

    <meta property="og:title" content="RestaurantIA - Analyse IA des commentaires Google" />
    <meta property="og:description" content="Découvrez ce que vos clients pensent vraiment avec notre analyse IA des commentaires Google" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@lovable_dev" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
    <!-- Google Maps API and Custom Implementation -->
    <script>
      /********** CONFIG **********/
      const SUPABASE_URL  = "https://zzjmtipdsccxmmoaetlp.supabase.co";      // NEXT_PUBLIC_SUPABASE_URL
      const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6am10aXBkc2NjeG1tb2FldGxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MjY1NjksImV4cCI6MjA3MzIwMjU2OX0.9y4TO3Hbp2rgD33ygLNRtDZiBbMEJ6Iz2SW6to6wJkU"; // NEXT_PUBLIC_SUPABASE_ANON_KEY
      /****************************/

      // charge supabase-js si absent
      async function supa() {
        if (!window.supabase) {
          await new Promise((res) => {
            const s = document.createElement('script');
            s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
            s.onload = res;
            document.head.appendChild(s);
          });
          window.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
            auth: { persistSession: true, autoRefreshToken: true }
          });
        }
        return window.supabase;
      }

      function setVal(id, v) { const el = document.getElementById(id); if (el) el.value = v ?? ""; }

      // ---- Appel Edge Function + upsert Supabase ----
      async function saveSelectedPlace(place_id) {
        const supabase = await supa();

        // vérifie session
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) { alert("Connecte-toi d'abord."); return; }

        // Edge Function (clé Google cachée côté Supabase)
        const url = `${SUPABASE_URL}/functions/v1/place-details`;
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "content-type": "application/json",
            "Authorization": `Bearer ${SUPABASE_ANON}`
          },
          body: JSON.stringify({ place_id })
        });
        if (!res.ok) { alert("Erreur Google Places (Edge Function)"); return; }

        const d = await res.json();

        // remplit l'UI
        setVal('venue_name', d.name);
        setVal('venue_address', d.address);
        setVal('venue_phone', d.phone);
        setVal('venue_website', d.website);

        // upsert
        const payload = {
          owner_id: user.id,
          place_id: d.place_id,
          name: d.name ?? 'Sans nom',
          address: d.address ?? null,
          phone_number: d.phone ?? null,
          website: d.website ?? null,
          google_rating: d.rating ?? null,
          opening_hours: d.opening_hours ?? null,
          lat: d.lat ?? null,
          lng: d.lng ?? null
        };

        const { error } = await supabase.from('venues').upsert(payload, { onConflict: 'place_id' });
        if (error) { alert(error.message || "Erreur enregistrement (RLS ?)"); return; }

        alert("Établissement enregistré ✅");
      }

      // ---- Autocomplete : remplit le champ et mémorise le place_id ----
      window.initAutocomplete = async function initAutocomplete() {
        console.log('Google Maps API loaded and ready');
        window.googleMapsLoaded = true;
        // Dispatch custom event to notify React components
        window.dispatchEvent(new CustomEvent('googleMapsLoaded'));

        const input = document.getElementById('venueSearch');
        const hidden = document.getElementById('selected_place_id');
        const btn = document.getElementById('analyzeBtn');

        if (!input || !hidden || !btn) {
          console.log('Required elements not found:', { input: !!input, hidden: !!hidden, btn: !!btn });
          return;
        }

        // eslint-disable-next-line no-undef
        const ac = new google.maps.places.Autocomplete(input, {
          types: ['establishment'],
          fields: ['place_id','name','formatted_address']
        });

        ac.addListener('place_changed', () => {
          const place = ac.getPlace();
          if (!place || !place.place_id) { return; }

          // 1) afficher "Nom — Adresse" dans l'input
          const label = [place.name, place.formatted_address].filter(Boolean).join(" — ");
          input.value = label;

          // 2) garder le place_id pour le bouton
          hidden.value = place.place_id;

          // 3) activer le bouton
          btn.disabled = false;
        });

        // clic du bouton "Analyser cet établissement"
        btn.addEventListener('click', async () => {
          const pid = hidden.value;
          if (!pid) { alert("Choisis d'abord un établissement"); return; }
          btn.disabled = true; const old = btn.textContent; btn.textContent = "Analyse en cours…";
          try { await saveSelectedPlace(pid); }
          finally { btn.disabled = false; btn.textContent = old; }
        });

        console.log('Google Places Autocomplete initialized');
      };

      // Make functions available globally
      window.saveSelectedPlace = saveSelectedPlace;
    </script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=YOUR_BROWSER_KEY&libraries=places&callback=initAutocomplete">
    </script>
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
